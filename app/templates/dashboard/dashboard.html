{% extends "base.html" %} {% block title %}Analytics Dashboard{% endblock %} {%
block content %}
<div class="bg-green-50 text-gray-800 h-screen overflow-hidden">
  <!-- Mobile Navbar -->
  <div
    class="md:hidden flex justify-between items-center px-4 py-3 bg-white border-b shadow-sm"
  >
    <button onclick="toggleSidebar()" class="text-green-700">
      <i data-lucide="menu" class="w-6 h-6"></i>
    </button>
    <div class="flex items-center gap-2">
      <a class="sheet border rounded-md p-2 text-green-700 pointer-cursor" href="/" target="_blank" rel="noopener noreferrer">Spreadsheet</a>
      <img
        src="{{ user.picture }}"
        alt="User"
        class="w-9 h-9 rounded-full border object-cover"
      />
    </div>
  </div>

  <!-- Sidebar Overlay (Mobile only) -->
  <div
    id="sidebar-backdrop"
    class="fixed inset-0 bg-black bg-opacity-40 z-20 hidden md:hidden"
    onclick="closeSidebar()"
  ></div>

  <div class="grid grid-cols-1 md:grid-cols-[260px,1fr] h-full w-full">
    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="bg-white shadow-md px-6 py-8 space-y-8 z-30 border-r fixed top-0 left-0 h-screen w-64 transform transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0 md:relative md:block"
    >
      <div
        class="text-2xl font-extrabold text-green-600 flex items-center gap-2"
      >
        <i data-lucide="bar-chart-3" class="w-6 h-6"></i> Centralized
      </div>

      <div>
        <p class="text-gray-600 text-sm">Logged in as</p>
        <div class="font-semibold">{{ user.name }}</div>
        <div class="text-sm text-gray-500">{{ user.email }}</div>
      </div>

      <!-- Facebook Page -->
      <div class="mt-6">
        <h2
          class="text-sm font-semibold text-gray-600 mb-2 flex items-center gap-2"
        >
          <i data-lucide="facebook" class="w-4 h-4 text-green-600"></i>
          Facebook Page
        </h2>
        <!-- Month Dropdown -->
        <label class="block text-xs text-gray-500 mb-1 mt-4">Month</label>
        <select
          id="month-select"
          class="w-full border rounded px-2 py-1 text-sm focus:outline-none focus:ring focus:border-green-500"
        >
          <!-- Options will be added dynamically -->
        </select>

        <!-- Brand Dropdown -->
        <label class="block text-xs text-gray-500 mb-1">Brand</label>
        <select
          id="brand-select"
          class="w-full border rounded px-2 py-1 text-sm focus:outline-none focus:ring focus:border-green-500"
        >
          <option value="BAJI">BAJI</option>
          <option value="SIX6S">SIX6S</option>
          <option value="JEETBUZZ">JEETBUZZ</option>
          <option value="BADSHA">BADSHA</option>
        </select>

        <!-- Currency Dropdown -->
        <label class="block text-xs text-gray-500 mt-3 mb-1">Currency</label>
        <select
          id="currency-select"
          class="w-full border rounded px-2 py-1 text-sm focus:outline-none focus:ring focus:border-green-500"
        >
          <option value="">Select a currency</option>
        </select>
      </div>

      <button
        onclick="logout()"
        class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition"
      >
        Logout
      </button>
    </aside>

    <!-- Main Content -->
    <main class="relative flex flex-col h-screen overflow-hidden">
      <!-- Sticky Header -->
      <header class="sticky top-0 z-10 bg-white shadow-sm border-b px-6 py-4">
        <div
          class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
        >
          <div>
            <h1
              class="text-xl md:text-2xl font-bold text-green-700 flex items-center gap-2"
            >
              <i data-lucide="pie-chart" class="w-6 h-6 text-green-500"></i>
              Trend Analytics Dashboard
            </h1>
            <p class="text-gray-600 text-sm">
              <!-- Comparing <strong>{{ today_label }}</strong> vs -->
              Today's Trends & 31-Day Performance
              <span class="block"
                >DATE: <strong>{{ today_label }}</strong></span
              >
            </p>
          </div>

          <div class="flex items-center gap-2">
            <a class="hidden md:flex sheet border rounded-md p-2 text-green-700 pointer-cursor hover:bg-gray-100" href="/" target="_blank" rel="noopener noreferrer">Spreadsheet</a>
            <img
              src="{{ user.picture }}"
              alt="User"
              class="w-10 h-10 rounded-full border object-cover hidden md:block"
            />
          </div>
        </div>

        <!-- Tabs -->
        <div class="mt-4 flex gap-6 border-b pb-2 overflow-x-auto">
          {% for tab in ['Daily', 'Monthly', 'Total'] %}
          <button
            onclick="showTab('{{ tab }}')"
            class="tab-btn {% if tab == 'Daily' %}text-green-600 font-semibold border-b-2 border-green-600{% else %}text-gray-600 hover:text-green-700{% endif %} pb-1 transition duration-300 whitespace-nowrap"
          >
            {{ tab }}
          </button>
          {% endfor %}
        </div>
      </header>

      <!-- Tab Content -->
      <div id="d-tab-content" class="flex-1 overflow-y-auto p-2 md:p-4"></div>
      <div class="p-10 flex md:hidden"></div>
    </main>
  </div>
</div>

<!-- Enhanced Dashboard Loader -->
<div
  id="dashboard-loader"
  class="hidden absolute inset-0 bg-white bg-opacity-80 z-50 flex flex-col items-center justify-center space-y-4"
>
  <!-- Spinner -->
  <div class="relative w-14 h-14">
    <div
      class="absolute inset-0 rounded-full border-4 border-t-green-500 border-gray-300 animate-spin"
    ></div>
    <div class="absolute inset-1 rounded-full bg-white"></div>
    <!-- Sheet Icon Center -->
    <svg
      class="absolute inset-2 w-6 h-6 text-green-500 m-auto"
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-6m-6-6l6 6m-6-6v6h6"
      />
    </svg>
  </div>

  <!-- Loading Text -->
  <div class="text-sm text-gray-600 font-medium animate-pulse tracking-wide">
    Loading data from spreadsheet...
  </div>
</div>

<!-- JS -->
<script>
  const buttons = document.querySelectorAll(".tab-btn");
  const tabContents = document.querySelectorAll(".tab-content");
  const sidebar = document.getElementById("sidebar");
  const sidebarBackdrop = document.getElementById("sidebar-backdrop");

  const brandSelect = document.getElementById("brand-select");
  const currencySelect = document.getElementById("currency-select");
  const monthSelect = document.getElementById("month-select");

  const brandToCurrency = {
    BAJI: ["BDT", "PKR", "NPR", "INR"],
    SIX6S: ["BDT", "PKR", "INR"],
    JEETBUZZ: ["BDT", "PKR", "INR", "BDT-NEW", "INR-NEW"],
    BADSHA: ["BDT"],
  };

  function showTab(tab) {
    const buttons = document.querySelectorAll(".tab-btn");
    const tabContents = document.querySelectorAll(".tab-content");

    buttons.forEach((btn) => {
      btn.classList.remove(
        "text-green-600",
        "font-semibold",
        "border-b-2",
        "border-green-600"
      );
      if (btn.textContent.trim() === tab) {
        btn.classList.add(
          "text-green-600",
          "font-semibold",
          "border-b-2",
          "border-green-600"
        );
      }
    });

    tabContents.forEach((el) => el.classList.add("hidden"));

    const activeTab = document.getElementById(`${tab}-tab`);
    if (activeTab) {
      activeTab.classList.remove("hidden");

      setTimeout(() => {
        document.querySelectorAll("canvas.chart").forEach((canvas) => {
          if (canvas._chartInstance) canvas._chartInstance.resize();
        });
      }, 100);
    }
  }

  function toggleSidebar() {
    sidebar.classList.toggle("-translate-x-full");
    sidebarBackdrop.classList.toggle("hidden");
  }

  function closeSidebar() {
    sidebar.classList.add("-translate-x-full");
    sidebarBackdrop.classList.add("hidden");
  }

  function logout() {
    fetch("/auth/logout", { method: "GET", credentials: "include" }).then(
      () => {
        localStorage.removeItem("google_id_token");
        window.location.href = "/";
      }
    );
  }

  // ✅ Utility: Populate currency options
  function populateCurrencyDropdown(brand) {
    currencySelect.innerHTML = "";
    if (brandToCurrency[brand]) {
      brandToCurrency[brand].forEach((currency) => {
        const option = document.createElement("option");
        option.value = currency;
        option.textContent = currency;
        currencySelect.appendChild(option);
      });
    }
  }

  // init chart
  function initAllCharts() {
    setTimeout(() => {
      document.querySelectorAll("canvas.chart").forEach((canvas) => {
        const ctx = canvas.getContext("2d");

        const labels = JSON.parse(canvas.dataset.chartLabels || "[]");
        const values = JSON.parse(canvas.dataset.chartValues || "[]");

        // Destroy any existing chart instance first (if re-rendering)
        if (canvas._chartInstance) {
          canvas._chartInstance.destroy();
        }

        const chart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "History",
                data: values,
                borderColor: "#16a34a",
                backgroundColor: "rgba(22,163,74,0.1)",
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 6, // highlight on hover
                pointHitRadius: 12, // larger clickable area
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 0 },
            interaction: {
              mode: "index",
              intersect: false,
            },
            elements: {
              point: {
                radius: 3,
                hitRadius: 20,
                hoverRadius: 7,
              },
            },
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                ticks: { font: { size: 10 } },
                autoSkip: false,
              },
              y: {
                beginAtZero: true,
                ticks: { font: { size: 10 } },
              },
            },
          },
        });

        canvas._chartInstance = chart;
      });
    }, 150);
  }

  function updateDashboard(data) {
    const tabContentParent = document.querySelector("#d-tab-content");
    const groupedSummary = data.grouped_summary;
    const tabs = ["Daily", "Monthly", "Total"];
    let allTabContent = "";

    tabs.forEach((tab, tabIndex) => {
      const tabData = groupedSummary[tab];
      let sectionHTML = `
      <section id="${tab}-tab"
        class="tab-content ${
          tab !== "Daily" ? "hidden" : ""
        } grid grid-cols-1 md:grid-cols-2 gap-4 transition-all duration-300 ease-in-out">
    `;

      tabData.forEach(([category, items]) => {
        const spanClass =
          category.toLowerCase() === "engagements" && items.length >= 2
            ? "col-span-1 md:col-span-2"
            : "";

        let categoryHTML = `
        <div class="bg-white shadow rounded-2xl p-4 md:p-5 ${spanClass}">
          <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2 flex items-center gap-2">
            <i data-lucide="calendar" class="w-4 h-4 text-green-500"></i>
            ${category}
          </h3>
          <div class="flex flex-wrap gap-4">
      `;

        items.forEach((item, i) => {
          document.querySelectorAll(".sheet").forEach(el => {
            el.href = item.sheet_url;
          });

          const isGrowth = parseFloat(item.delta) >= 0;
          const isTwoItems = items.length === 2;

          const itemHTML = `
          <div class="flex-1 min-w-[300px] max-w-full 
              ${isTwoItems ? "md:basis-[calc(50%-0.5rem)]" : "md:basis-full"} 
              bg-white border border-gray-200 shadow-sm hover:shadow-md 
              transition-all duration-300 transform hover:-translate-y-1 
              rounded-xl p-4 flex flex-col md:flex-row justify-between items-center gap-4">

              <!-- Metric Display -->
              <div class="w-full md:w-fit flex flex-row md:flex-col items-center justify-between space-y-1.5">
                <div>
                  <!-- Metric Label -->
                  <div class="text-sm font-medium text-gray-500 uppercase tracking-wide">
                    ${item.metric}
                  </div>

                  <!-- Today's Value -->
                  <div class="text-2xl font-extrabold ${
                    isGrowth ? "text-green-700" : "text-red-600"
                  }">
                    ${Number(item.today).toLocaleString()}
                  </div>
                </div>

                <!-- Yesterday's Value -->
                <div class="shadow p-2">
                    <div class="text-xs text-gray-500">
                      Yesterday: 
                      <span class="font-bold ${
                        isGrowth ? "text-red-600" : "text-green-600"
                      }">
                        ${Number(item.yesterday).toLocaleString()}
                      </span>
                    </div>

                    <!-- Delta / Change -->
                    <div class="flex items-center gap-1 text-sm font-semibold 
                                ${
                                  isGrowth ? "text-green-600" : "text-red-600"
                                }">
                      <i data-lucide="${
                        isGrowth ? "arrow-up-right" : "arrow-down-right"
                      }" class="w-4 h-4"></i>
                      ${Number(item.delta).toLocaleString()}
                      <span class="text-xs font-normal text-gray-500">(${
                        item.change
                      })</span>
                    </div>
                </div>
              </div>


              <!-- Chart with Scrollable X Axis -->
              <div class="rounded-xl bg-white shadow p-2 mt-2 w-full max-w-full overflow-hidden">
                  <span class="font-bold text-gray-500">Recent 31-Day Metrics</span>

                  <!-- Chart Scroll Wrapper -->
                  <div class="w-full overflow-x-auto">
                    <!-- Scrollable Area -->
                    <div class="inline-block min-w-[850px] h-[180px]">
                      <canvas
                        data-chart-id="chart-${tab}-${category}-${i}"
                        data-chart-labels='${JSON.stringify(
                          item.chart.labels.map((label) => {
                            const parts = label.split("/");
                            if (parts.length === 3) {
                              const [day, month, year] = parts.map(Number);
                              const date = new Date(year, month - 1, day);
                              return date.toLocaleDateString("en-US", {
                                month: "short",
                                day: "numeric",
                              });
                            }
                            return label;
                          })
                        )}'
                        data-chart-values='${JSON.stringify(item.chart.values)}'
                        class="chart w-full h-full">
                      </canvas>
                    </div>
                  </div>
                </div>


            </div>


        `;

          categoryHTML += itemHTML;
        });

        categoryHTML += `</div></div>`;
        sectionHTML += categoryHTML;
      });

      sectionHTML += `</section>`;
      allTabContent += sectionHTML;
    });

    tabContentParent.innerHTML = allTabContent;

    // Reinitialize any dynamic components (like lucide icons or charts)
    if (window.lucide) lucide.createIcons();
    initAllCharts(); // You'll need to implement this to pick up canvas elements
  }

  //function handle api call
  function fetchData(selectedBrand, selectedCurrency, selectedMonth) {
    const loader = document.getElementById("dashboard-loader");
    loader.classList.remove("hidden");

    fetch(
      `/api/dashboard-data?brand=${selectedBrand}&currency=${selectedCurrency}&month=${selectedMonth}`
    )
      .then((res) => res.json())
      .then((data) => {
        updateDashboard(data);
        showTab("Daily");
        // Update your UI with new data here if needed
      })
      .catch((err) => {
        console.error("API error:", err);
      })
      .finally(() => {
        loader.classList.add("hidden");
      });
  }
  // ✅ Brand change event: Only update currency options
  brandSelect.addEventListener("change", () => {
    const selectedBrand = brandSelect.value;
    const selectedCurrency = currencySelect.value;
    const selectedMonth = monthSelect.value
    populateCurrencyDropdown(selectedBrand);
    fetchData(selectedBrand, selectedCurrency,selectedMonth);
  });

  // ✅ Currency change event: Fire API call
  currencySelect.addEventListener("change", () => {
    const selectedBrand = brandSelect.value;
    const selectedCurrency = currencySelect.value;
    const selectedMonth = monthSelect.value
    if (selectedBrand && selectedCurrency) {
      fetchData(selectedBrand, selectedCurrency, selectedMonth);
    }
  });

  monthSelect.addEventListener("change", () => {
    const selectedBrand = brandSelect.value;
    const selectedCurrency = currencySelect.value;
    const selectedMonth = monthSelect.value
    if (selectedBrand && selectedCurrency && selectedMonth) {
      fetchData(selectedBrand, selectedCurrency, selectedMonth);
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    //showTab("Daily");
   
    const monthNames = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
    
    const today = new Date();
    const currentMonth = today.getMonth(); // 0-11
    const currentYear = today.getFullYear();

    monthNames.forEach((month, index) => {
      const option = document.createElement("option");
      option.value = month; // Use 1-12
      option.textContent = `${month} ${currentYear}`;
      if (index > currentMonth) {
        option.disabled = true; // Disable future months
      }
      if (index === currentMonth) {
        option.selected = true;
      }
      monthSelect.appendChild(option);
    });

    if (window.lucide) window.lucide.createIcons();
    populateCurrencyDropdown("BAJI");
    fetchData(brandSelect.value, currencySelect.value, monthSelect.value);
  });

  // Resize on window
  window.addEventListener("resize", () => {
    document.querySelectorAll("canvas.chart").forEach((canvas) => {
      if (canvas._chartInstance) canvas._chartInstance.resize();
    });
  });
</script>
{% endblock %}
