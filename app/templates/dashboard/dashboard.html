{% extends "base.html" %} {% block title %}Analytics Dashboard{% endblock %} {%
block content %}
<div class="bg-green-50 text-gray-800 h-screen overflow-hidden">
  <!-- Mobile Navbar -->
  <div
    class="md:hidden flex justify-between items-center px-4 py-3 bg-white border-b shadow-sm"
  >
    <button onclick="toggleSidebar()" class="text-green-700">
      <i data-lucide="menu" class="w-6 h-6"></i>
    </button>
    <img
      src="{{ user.picture }}"
      alt="User"
      class="w-9 h-9 rounded-full border object-cover"
    />
  </div>

  <!-- Sidebar Overlay (Mobile only) -->
  <div
    id="sidebar-backdrop"
    class="fixed inset-0 bg-black bg-opacity-40 z-20 hidden md:hidden"
    onclick="closeSidebar()"
  ></div>

  <div class="grid grid-cols-1 md:grid-cols-[260px,1fr] h-full w-full">
    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="bg-white shadow-md px-6 py-8 space-y-8 z-30 border-r fixed top-0 left-0 h-screen w-64 transform transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0 md:relative md:block"
    >
      <div
        class="text-2xl font-extrabold text-green-600 flex items-center gap-2"
      >
        <i data-lucide="bar-chart-3" class="w-6 h-6"></i> Centralized
      </div>

      <div>
        <p class="text-gray-600 text-sm">Logged in as</p>
        <div class="font-semibold">{{ user.name }}</div>
        <div class="text-sm text-gray-500">{{ user.email }}</div>
      </div>

      <!-- Facebook Selection -->
      <div class="mt-6">
        <h2
          class="text-sm font-semibold text-gray-600 mb-2 flex items-center gap-2"
        >
          <i data-lucide="facebook" class="w-4 h-4 text-blue-600"></i>
          Facebook Selection
        </h2>

        <!-- Brand Dropdown -->
        <label class="block text-xs text-gray-500 mb-1">Brand</label>
        <select
          id="brand-select"
          class="w-full border rounded px-2 py-1 text-sm focus:outline-none focus:ring focus:border-green-500"
        >
          <option value="BAJI">BAJI</option>
          <option value="SIX6S">SIX6S</option>
          <option value="JEETBUZZ">JEETBUZZ</option>
          <option value="BADSHA">BADSHA</option>
        </select>

        <!-- Currency Dropdown -->
        <label class="block text-xs text-gray-500 mt-3 mb-1">Currency</label>
        <select
          id="currency-select"
          class="w-full border rounded px-2 py-1 text-sm focus:outline-none focus:ring focus:border-green-500"
        >
          <option value="">Select a currency</option>
        </select>
      </div>

      <button
        onclick="logout()"
        class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition"
      >
        Logout
      </button>
    </aside>

    <!-- Main Content -->
    <main class="relative flex flex-col h-screen overflow-hidden">
      <!-- Sticky Header -->
      <header class="sticky top-0 z-10 bg-white shadow-sm border-b px-6 py-4">
        <div
          class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
        >
          <div>
            <h1
              class="text-xl md:text-2xl font-bold text-green-700 flex items-center gap-2"
            >
              <i data-lucide="pie-chart" class="w-6 h-6 text-green-500"></i>
              Trend Analytics Dashboard
            </h1>
            <p class="text-gray-600 text-sm">
              <!-- Comparing <strong>{{ today_label }}</strong> vs -->
              Today's Trends & 31-Day Performance
              <span class="block">DATE: <strong>{{ today_label }}</strong></span>
            </p>
          </div>
          <img
            src="{{ user.picture }}"
            alt="User"
            class="w-10 h-10 rounded-full border object-cover hidden md:block"
          />
        </div>

        <!-- Tabs -->
        <div class="mt-4 flex gap-6 border-b pb-2 overflow-x-auto">
          {% for tab in ['Daily', 'Monthly', 'Total'] %}
          <button
            onclick="showTab('{{ tab }}')"
            class="tab-btn {% if tab == 'Daily' %}text-green-600 font-semibold border-b-2 border-green-600{% else %}text-gray-600 hover:text-green-700{% endif %} pb-1 transition duration-300 whitespace-nowrap"
          >
            {{ tab }}
          </button>
          {% endfor %}
        </div>
      </header>

      <!-- Dynamic Tab -->
      <!-- <div
        id="d-tab-content"
        class="flex-1 overflow-y-auto p-4 border border-red-500"
      ></div> -->
      <!-- Tab Content -->
      <div id="d-tab-content" class="flex-1 overflow-y-auto p-4">
        <!-- {% for tab in ['Daily', 'Monthly', 'Total'] %}
        <section
          id="{{ tab }}-tab"
          class="tab-content {% if tab != 'Daily' %}hidden{% endif %} grid grid-cols-1 md:grid-cols-2 gap-4 transition-all duration-300 ease-in-out"
        >
          {% set tab_data = grouped_summary[tab] %} {% for category, items in
          tab_data %} {% set span_class = 'col-span-1 md:col-span-2' if
          category|lower == 'engagements' or items|length >= 2 else '' %}
          <div class="bg-white shadow rounded-2xl p-5 {{ span_class }}">
            <h3
              class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2 flex items-center gap-2"
            >
              <i data-lucide="calendar" class="w-4 h-4 text-green-500"></i>
              {{ category }}
            </h3>

            <div class="flex flex-wrap gap-4">
              {% for item in items %} {% set is_two_items = items|length == 2
              %}{% set is_growth = item.delta | float >= 0 %}
              <div
                class="flex-1 min-w-[300px] max-w-full {% if is_two_items %} md:basis-[calc(50%-0.5rem)] {% else %} md:basis-full {% endif %} bg-white border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1 rounded-xl p-4 flex flex-col md:flex-row justify-between items-center gap-4"
              >
              
                <div class="w-fit">
                  <div class="text-sm font-medium text-gray-600">
                    {{ item.metric }}
                  </div>
                  <div class="text-2xl font-extrabold text-green-700">
                    {{ '{:,}'.format(item.today | int) }}
                  </div>
                  <div class="text-xs text-gray-500">
                    Yesterday:
                    <span class="font-semibold"
                      >{{ '{:,}'.format(item.yesterday | int) }}</span
                    >
                  </div>
                  <div
                    class="mt-1 flex items-center gap-1 text-sm font-semibold {% if is_growth %}text-green-600{% else %}text-red-600{% endif %}"
                  >
                    <i
                      data-lucide="{% if is_growth %}arrow-up{% else %}arrow-down{% endif %}"
                      class="w-4 h-4"
                    ></i>
                    {{ '{:,}'.format(item.delta | int) }}
                    <span class="text-gray-500 font-normal text-xs"
                      >({{ item.change }})</span
                    >
                  </div>
                </div>

                <div
                  class="rounded-xl bg-white shadow p-2 mt-2 w-full h-[200px]"
                >
                  <canvas
                    data-chart-id="chart-{{ loop.index0 }}"
                    data-chart-labels='{{ item.chart["labels"] | map("string") | map("replace", "/.*", "") | list | tojson }}'
                    data-chart-values='{{ item.chart["values"] | tojson }}'
                    class="chart w-full"
                  ></canvas>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </section>
        {% endfor %} -->
      </div>
      <div class="p-10 flex md:hidden"></div>
    </main>
  </div>
</div>

<!-- Enhanced Dashboard Loader -->
<div
  id="dashboard-loader"
  class="hidden absolute inset-0 bg-white bg-opacity-80 z-50 flex flex-col items-center justify-center space-y-4"
>
  <!-- Spinner -->
  <div class="relative w-14 h-14">
    <div
      class="absolute inset-0 rounded-full border-4 border-t-green-500 border-gray-300 animate-spin"
    ></div>
    <div class="absolute inset-1 rounded-full bg-white"></div>
    <!-- Sheet Icon Center -->
    <svg
      class="absolute inset-2 w-6 h-6 text-green-500 m-auto"
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-6m-6-6l6 6m-6-6v6h6"
      />
    </svg>
  </div>

  <!-- Loading Text -->
  <div class="text-sm text-gray-600 font-medium animate-pulse tracking-wide">
    Loading data from spreadsheet...
  </div>
</div>

<!-- JS -->
<script>
  const buttons = document.querySelectorAll(".tab-btn");
  const tabContents = document.querySelectorAll(".tab-content");
  const sidebar = document.getElementById("sidebar");
  const sidebarBackdrop = document.getElementById("sidebar-backdrop");

  const brandSelect = document.getElementById("brand-select");
  const currencySelect = document.getElementById("currency-select");

  const brandToCurrency = {
    BAJI: ["BDT", "PKR", "NPR", "INR"],
    SIX6S: ["BDT", "PKR", "INR"],
    JEETBUZZ: ["BDT", "PKR", "INR", "BDT-NEW", "INR-NEW"],
    BADSHA: ["BDT"],
  };

  function showTab(tab) {
    const buttons = document.querySelectorAll(".tab-btn");
    const tabContents = document.querySelectorAll(".tab-content");

    buttons.forEach((btn) => {
      btn.classList.remove(
        "text-green-600",
        "font-semibold",
        "border-b-2",
        "border-green-600"
      );
      if (btn.textContent.trim() === tab) {
        btn.classList.add(
          "text-green-600",
          "font-semibold",
          "border-b-2",
          "border-green-600"
        );
      }
    });

    tabContents.forEach((el) => el.classList.add("hidden"));

    const activeTab = document.getElementById(`${tab}-tab`);
    if (activeTab) {
      activeTab.classList.remove("hidden");

      setTimeout(() => {
        document.querySelectorAll("canvas.chart").forEach((canvas) => {
          if (canvas._chartInstance) canvas._chartInstance.resize();
        });
      }, 100);
    }
  }

  function toggleSidebar() {
    sidebar.classList.toggle("-translate-x-full");
    sidebarBackdrop.classList.toggle("hidden");
  }

  function closeSidebar() {
    sidebar.classList.add("-translate-x-full");
    sidebarBackdrop.classList.add("hidden");
  }

  function logout() {
    fetch("/auth/logout", { method: "GET", credentials: "include" }).then(
      () => {
        localStorage.removeItem("google_id_token");
        window.location.href = "/";
      }
    );
  }

  // ✅ Utility: Populate currency options
  function populateCurrencyDropdown(brand) {
    currencySelect.innerHTML = "";
    if (brandToCurrency[brand]) {
      brandToCurrency[brand].forEach((currency) => {
        const option = document.createElement("option");
        option.value = currency;
        option.textContent = currency;
        currencySelect.appendChild(option);
      });
    }
  }

  // init chart
  function initAllCharts() {
    setTimeout(() => {
      document.querySelectorAll("canvas.chart").forEach((canvas) => {
        const ctx = canvas.getContext("2d");

        const labels = JSON.parse(canvas.dataset.chartLabels || "[]");
        const values = JSON.parse(canvas.dataset.chartValues || "[]");

        // Destroy any existing chart instance first (if re-rendering)
        if (canvas._chartInstance) {
          canvas._chartInstance.destroy();
        }

        const chart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "History",
                data: values,
                borderColor: "#16a34a",
                backgroundColor: "rgba(22,163,74,0.1)",
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointRadius: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              duration: 0, // optional: prevents slow load
            },
            plugins: {
              //title: {
              //  display: true,
              //  text: "7-Day Insights",
              //  font: {
              //    size: 14,
              //    weight: "bold",
              //  },
              //  padding: {
              //    top: 10,
              //    bottom: 20,
              //  },
              //  color: "#16a34a", // Tailwind gray-800
              // },
              legend: { display: false },
            },
            scales: {
              x: {
                ticks: { font: { size: 10 } },
                autoSkip: false,
              },
              y: {
                beginAtZero: true,
                ticks: { font: { size: 10 } },
              },
            },
          },
        });

        canvas._chartInstance = chart;
      });
    }, 150); // Delay allows DOM layout to settle
  }

  function updateDashboard(data) {
    const tabContentParent = document.querySelector("#d-tab-content");
    const groupedSummary = data.grouped_summary;
    const tabs = ["Daily", "Monthly", "Total"];
    let allTabContent = "";

    tabs.forEach((tab, tabIndex) => {
      const tabData = groupedSummary[tab];
      let sectionHTML = `
      <section id="${tab}-tab"
        class="tab-content ${
          tab !== "Daily" ? "hidden" : ""
        } grid grid-cols-1 md:grid-cols-2 gap-4 transition-all duration-300 ease-in-out">
    `;

      tabData.forEach(([category, items]) => {
        const spanClass =
          category.toLowerCase() === "engagements" && items.length >= 2
            ? "col-span-1 md:col-span-2"
            : "";

        let categoryHTML = `
        <div class="bg-white shadow rounded-2xl p-5 ${spanClass}">
          <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2 flex items-center gap-2">
            <i data-lucide="calendar" class="w-4 h-4 text-green-500"></i>
            ${category}
          </h3>
          <div class="flex flex-wrap gap-4">
      `;

        items.forEach((item, i) => {
          const isGrowth = parseFloat(item.delta) >= 0;
          const isTwoItems = items.length === 2;

          const itemHTML = `
          <div class="flex-1 min-w-[300px] max-w-full 
              ${isTwoItems ? "md:basis-[calc(50%-0.5rem)]" : "md:basis-full"} 
              bg-white border border-gray-200 shadow-sm hover:shadow-md 
              transition-all duration-300 transform hover:-translate-y-1 
              rounded-xl p-4 flex flex-col md:flex-row justify-between items-center gap-4">

              <!-- Metric Display -->
              <div class="w-full md:w-fit flex flex-row md:flex-col items-center justify-between space-y-1.5">
                <div>
                  <!-- Metric Label -->
                  <div class="text-sm font-medium text-gray-500 uppercase tracking-wide">
                    ${item.metric}
                  </div>

                  <!-- Today's Value -->
                  <div class="text-2xl font-extrabold ${isGrowth ? 'text-green-700' : 'text-red-600'}">
                    ${Number(item.today).toLocaleString()}
                  </div>
                </div>

                <!-- Yesterday's Value -->
                <div class="shadow p-2">
                    <div class="text-xs text-gray-500">
                      Yesterday: 
                      <span class="font-bold ${isGrowth ? 'text-red-600' : 'text-green-600'}">
                        ${Number(item.yesterday).toLocaleString()}
                      </span>
                    </div>

                    <!-- Delta / Change -->
                    <div class="flex items-center gap-1 text-sm font-semibold 
                                ${isGrowth ? 'text-green-600' : 'text-red-600'}">
                      <i data-lucide="${isGrowth ? 'arrow-up-right' : 'arrow-down-right'}" class="w-4 h-4"></i>
                      ${Number(item.delta).toLocaleString()}
                      <span class="text-xs font-normal text-gray-500">(${item.change})</span>
                    </div>
                </div>
              </div>


              <!-- Chart with Scrollable X Axis -->
              <div class="rounded-xl bg-white shadow p-2 mt-2 w-full max-w-full overflow-hidden">
                  <span class="font-bold text-gray-500">Recent 31-Day Metrics (Newest First)</span>

                  <!-- Chart Scroll Wrapper -->
                  <div class="w-full overflow-x-auto">
                    <!-- Scrollable Area -->
                    <div class="inline-block min-w-[850px] h-[180px]">
                      <canvas
                        data-chart-id="chart-${tab}-${category}-${i}"
                        data-chart-labels='${JSON.stringify(
                          item.chart.labels.map((label) => {
                            const parts = label.split("/");
                            if (parts.length === 3) {
                              const [day, month, year] = parts.map(Number);
                              const date = new Date(year, month - 1, day);
                              return date.toLocaleDateString("en-US", {
                                month: "short",
                                day: "numeric",
                              });
                            }
                            return label;
                          })
                        )}'
                        data-chart-values='${JSON.stringify(item.chart.values)}'
                        class="chart w-full h-full">
                      </canvas>
                    </div>
                  </div>
                </div>


            </div>


        `;

          categoryHTML += itemHTML;
        });

        categoryHTML += `</div></div>`;
        sectionHTML += categoryHTML;
      });

      sectionHTML += `</section>`;
      allTabContent += sectionHTML;
    });

    tabContentParent.innerHTML = allTabContent;

    // Reinitialize any dynamic components (like lucide icons or charts)
    if (window.lucide) lucide.createIcons();
    initAllCharts(); // You'll need to implement this to pick up canvas elements
  }

  //function handle api call
  function fetchData(selectedBrand, selectedCurrency) {
    const loader = document.getElementById("dashboard-loader");
    loader.classList.remove("hidden");

    fetch(
      `/api/dashboard-data?brand=${selectedBrand}&currency=${selectedCurrency}`
    )
      .then((res) => res.json())
      .then((data) => {
        updateDashboard(data);
        showTab("Daily");
        // Update your UI with new data here if needed
      })
      .catch((err) => {
        console.error("API error:", err);
      })
      .finally(() => {
        loader.classList.add("hidden");
      });
  }
  // ✅ Brand change event: Only update currency options
  brandSelect.addEventListener("change", () => {
    const selectedBrand = brandSelect.value;
    const selectedCurrency = currencySelect.value;
    populateCurrencyDropdown(selectedBrand);
    fetchData(selectedBrand, selectedCurrency);
  });

  // ✅ Currency change event: Fire API call
  currencySelect.addEventListener("change", () => {
    const selectedBrand = brandSelect.value;
    const selectedCurrency = currencySelect.value;

    if (selectedBrand && selectedCurrency) {
      fetchData(selectedBrand, selectedCurrency);
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    //showTab("Daily");
    if (window.lucide) window.lucide.createIcons();
    fetchData("BAJI", "BDT");
    populateCurrencyDropdown("BAJI");
  });

  // Resize on window
  window.addEventListener("resize", () => {
    document.querySelectorAll("canvas.chart").forEach((canvas) => {
      if (canvas._chartInstance) canvas._chartInstance.resize();
    });
  });
</script>
{% endblock %}
